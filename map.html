<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <title>Flight Following</title>
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <link rel="stylesheet" href="https://unpkg.com/leaflet/dist/leaflet.css" />
  <style>
    html, body { margin: 0; height: 100%; font-family: sans-serif; }
    #app { display: flex; height: 100vh; overflow: hidden; }
    #devicePane { width: 300px; background: #2e2e2e; color: white; padding: 10px; overflow-y: auto; z-index: 2; }
    #map { flex: 1; position: relative; z-index: 1; }
    .device { border-bottom: 1px solid #555; padding: 5px; cursor: pointer; }
    .device input { width: 90%; background: transparent; color: white; border: none; border-bottom: 1px solid white; }
    #bottomPane { position: absolute; bottom: 0; left: 0; right: 0; height: 33%; background: white; border-top: 2px solid #888; display: flex; flex-direction: column; z-index: 3; }
    #dragBar { height: 10px; background: #ccc; cursor: ns-resize; }
    #controls { display: flex; align-items: center; padding: 5px; }
    #controls select, #controls button { margin-right: 10px; }
    #tableContainer { flex: 1; overflow: auto; }
    table { width: 100%; border-collapse: collapse; }
    th, td { border: 1px solid #aaa; padding: 4px; text-align: left; }
    th.sortable:hover { cursor: pointer; background: #eee; }
  </style>
</head>
<body>
  <div id="app">
    <div id="devicePane"></div>
    <div id="map"></div>
    <div id="bottomPane">
      <div id="dragBar"></div>
      <div id="controls">
        <select id="flightSelector">
          <option value="current">Current Flight</option>
          <option value="2">Last 2 Flights</option>
          <option value="4">Last 4 Flights</option>
          <option value="today">Today</option>
          <option value="2days">Last 2 Days</option>
          <option value="7days">Last 7 Days</option>
        </select>
        <button id="fieldsBtn">Fields</button>
      </div>
      <div id="tableContainer">
        <table id="flightTable">
          <thead><tr></tr></thead>
          <tbody></tbody>
        </table>
      </div>
    </div>
  </div>
  <script src="https://unpkg.com/leaflet/dist/leaflet.js"></script>
  <script>
    const GH_USER = 'GitBoatyy';
    const GH_REPO = 'PiTrac';
    const GH_PATH = 'data';
    const POLL_INTERVAL = 10000;

    let devices = {}, lastTimestamps = {}, markers = {}, polylines = {}, selectedEsn = null, fileUrls = [];
    let visibleFields = ['esn','time','lat','lng','alt','spd','event_type'];
    const fieldLabels = { esn:'ESN', time:'Time', lat:'Lat', lng:'Long', alt:'Alt (M)', spd:'Spd', event_type:'Event Type' };

    const map = L.map('map').setView([49.8373, -119.3744], 13);
    L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png').addTo(map);

    document.getElementById('flightSelector').addEventListener('change', () => selectedEsn && updateFlightTable(devices[selectedEsn]));
    document.getElementById('fieldsBtn').addEventListener('click', () => {
      const allFields = Object.keys(fieldLabels);
      const choice = prompt('Enter fields to display, comma-separated:', visibleFields.join(','));
      if(choice) {
        visibleFields = choice.split(',').map(f=>f.trim()).filter(f=>allFields.includes(f));
        selectedEsn && updateFlightTable(devices[selectedEsn]);
      }
    });

    async function fetchFileList() {
      try {
        const items = await (await fetch(`https://api.github.com/repos/${GH_USER}/${GH_REPO}/contents/${GH_PATH}`)).json();
        fileUrls = items.filter(i=>i.name.endsWith('.json')).map(i=>i.download_url);
        await Promise.all(fileUrls.map(loadFile));
        setInterval(pollUpdates,POLL_INTERVAL);
      } catch(e){console.error(e)}
    }
    async function loadFile(url){ try{
        const json = await (await fetch(url)).json();
        // Sort features by timestamp to ensure chronological order
        json.features.slice().sort((a,b)=>new Date(a.properties.posTime)-new Date(b.properties.posTime)).forEach(processFeature);
        if(!selectedEsn) buildDevicePane();
      } catch(e){console.error(e)} }
    function processFeature(f){
      const p=f.properties; if(p.event_type==='Position Report') return;
      const esn=p.esn; const t=new Date(p.posTime).getTime();
      devices[esn]||(devices[esn]=[]), lastTimestamps[esn]||(lastTimestamps[esn]=0);
      if(t>lastTimestamps[esn]){
        devices[esn].push({ esn, time:p.posTime, lat: f.geometry.coordinates[1], lng: f.geometry.coordinates[0], alt:p.geometry?f.geometry.coordinates[2]:p.alt, spd:p.spd, event_type:p.event_type });
        lastTimestamps[esn]=t; selectedEsn===esn&&appendToMap(devices[esn].slice(-1)[0]);
      }
    }
    function pollUpdates(){ fileUrls.forEach(loadFile); }
    function getColor(pt){ const age=Date.now()-new Date(pt.time).getTime(); return age>5*60*1000?'black':pt.event_type==='MOVING'?'blue':'brown'; }
    function buildDevicePane(){
      const pane=document.getElementById('devicePane'); pane.innerHTML='';
      Object.entries(devices).forEach(([esn,arr])=>{
        if(!arr.length)return; const last=arr[arr.length-1];
        const ageMin=Math.floor((Date.now()-new Date(last.time))/60000);
        const div=document.createElement('div'); div.className='device'; div.title=`${last.unitId}\nLast report: ${ageMin} min ago`;
        const inp=document.createElement('input'); inp.value=last.unitId; inp.onchange=e=>last.unitId=e.target.value; div.appendChild(inp);
        div.insertAdjacentHTML('beforeend',`<div>${fieldLabels.event_type}: ${last.event_type}</div><div>${fieldLabels.lat}: ${last.lat}, ${fieldLabels.lng}: ${last.lng}</div><div>${fieldLabels.alt}: ${last.alt}</div><div>Last report: ${ageMin} min ago</div>`);
        div.onclick=()=>selectDevice(esn); pane.appendChild(div);
      });
      selectedEsn||Object.keys(devices)[0]&&selectDevice(Object.keys(devices)[0]);
    }
    function selectDevice(esn){ selectedEsn=esn; clearMap(); devices[esn].forEach(pt=>appendToMap(pt,false)); fitMapTo(esn); updateFlightTable(devices[esn]); }
    function clearMap(){ Object.values(markers).forEach(m=>map.removeLayer(m)); Object.values(polylines).flat().forEach(pl=>map.removeLayer(pl)); markers={},polylines={}; }
    function appendToMap(pt,pan=true){
      if(!polylines[selectedEsn])polylines[selectedEsn]=[];
      const arr=devices[selectedEsn]; if(arr.length>1){ const a=arr[arr.length-2],b=arr[arr.length-1]; const line=L.polyline([[a.lat,a.lng],[b.lat,b.lng]],{color:getColor(b),weight:3}).addTo(map);polylines[selectedEsn].push(line);}      
      markers[selectedEsn]&&map.removeLayer(markers[selectedEsn]);const icon=L.divIcon({html:`<div style="font-size:24px;color:${getColor(pt)}">✈️</div>`});markers[selectedEsn]=L.marker([pt.lat,pt.lng],{icon}).addTo(map);pan&&map.panTo([pt.lat,pt.lng]);
    }
    function fitMapTo(esn){ const grp=[];polylines[esn]?.forEach(pl=>grp.push(pl));markers[esn]&&grp.push(markers[esn]);grp.length&&map.fitBounds(L.featureGroup(grp).getBounds()); }
    function updateFlightTable(arr){
      const filter=document.getElementById('flightSelector').value;
      let data;
      if(['2','4','current'].includes(filter)){
        const segs=[];let cur=[];arr.forEach(p=>{if(p.event_type==='POWER ON'&&cur.length){segs.push(cur);cur=[];}cur.push(p);});segs.length&&cur.length&&segs.push(cur);
        data=filter==='current'?segs.slice(-1)[0]||[]:[].concat(...segs.slice(-parseInt(filter)));
      } else { const now=Date.now();const d={today:1,'2days':2,'7days':7}[filter];data=arr.filter(p=>now-new Date(p.time)<=d*24*3600*1000);}      
      const head=document.querySelector('#flightTable thead tr');head.innerHTML='';visibleFields.forEach(f=>{const th=document.createElement('th');th.textContent=fieldLabels[f]||f;th.className='sortable';th.onclick=()=>sortTable(f);head.appendChild(th);});
      const body=document.querySelector('#flightTable tbody');body.innerHTML='';data.slice().reverse().forEach(p=>{const tr=document.createElement('tr');visibleFields.forEach(f=>{const td=document.createElement('td');td.textContent = f==='lat'?p.lat.toFixed(4):f==='lng'?p.lng.toFixed(4):p[f];tr.appendChild(td);});body.appendChild(tr);});
    }
    function sortTable(col){const body=document.querySelector('#flightTable tbody');const rows=Array.from(body.rows);const idx=visibleFields.indexOf(col);const asc=!body.asc;body.asc=asc;rows.sort((a,b)=>asc?a.cells[idx].textContent.localeCompare(b.cells[idx].textContent,{numeric:true}):b.cells[idx].textContent.localeCompare(a.cells[idx].textContent,{numeric:true}));body.innerHTML='';rows.forEach(r=>body.appendChild(r));}
    const drag=document.getElementById('dragBar');let dragging=false;drag.onmousedown=()=>dragging=true;document.onmouseup=()=>dragging=false;document.onmousemove=e=>{dragging&&(document.getElementById('bottomPane').style.height=`${window.innerHeight-e.clientY}px`);};
    fetchFileList();
  </script>
</body>
</html>
